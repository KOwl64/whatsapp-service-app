<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations Dashboard - WhatsApp POD Service</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --turners-primary: #1e3a5f;
            --turners-secondary: #2d5a87;
            --turners-accent: #4a90d9;
            --turners-orange: #e67e22;
            --turners-success: #28a745;
            --turners-danger: #dc3545;
            --turners-warning: #ffc107;
            --bg-dark: #1a1d24;
            --bg-card: #242830;
            --bg-card-hover: #2d323c;
            --border-color: #3a3f4a;
            --text-primary: #f0f2f5;
            --text-secondary: #a0a5b0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .navbar-custom {
            background: linear-gradient(135deg, var(--turners-primary) 0%, var(--turners-secondary) 100%);
            padding: 0.75rem 1.5rem;
        }

        .navbar-brand { color: #fff !important; font-weight: 600; }

        .nav-link { color: rgba(255,255,255,0.85) !important; border-radius: 8px; margin: 0 0.25rem; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: #fff !important; }

        .main-container { padding: 1.5rem; max-width: 1600px; margin: 0 auto; }

        /* Health Status Hero */
        .health-hero { border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; color: #fff; }
        .health-hero.healthy { background: linear-gradient(135deg, var(--turners-success) 0%, #20c997 100%); }
        .health-hero.degraded { background: linear-gradient(135deg, var(--turners-warning) 0%, #fd7e14 100%); }
        .health-hero.unhealthy { background: linear-gradient(135deg, var(--turners-danger) 0%, #c82333 100%); }
        .health-hero.loading { background: linear-gradient(135deg, var(--turners-secondary) 0%, var(--turners-accent) 100%); }

        .health-icon { font-size: 2.5rem; }
        .health-title { font-size: 1.75rem; font-weight: 700; }
        .health-subtitle { opacity: 0.9; font-size: 0.9rem; }

        /* Cards */
        .custom-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            height: 100%;
            transition: all 0.2s ease;
        }

        .custom-card:hover { background: var(--bg-card-hover); }

        .card-header-custom {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .card-icon.green { background: rgba(40, 167, 69, 0.15); color: var(--turners-success); }
        .card-icon.blue { background: rgba(74, 144, 217, 0.15); color: var(--turners-accent); }
        .card-icon.orange { background: rgba(230, 126, 34, 0.15); color: var(--turners-orange); }
        .card-icon.red { background: rgba(220, 53, 69, 0.15); color: var(--turners-danger); }
        .card-icon.purple { background: rgba(111, 66, 193, 0.15); color: #6f42c1; }

        .card-title { font-size: 0.95rem; font-weight: 600; margin: 0; }

        /* Queue Status Cards */
        .queue-card {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .queue-value { font-size: 2rem; font-weight: 700; color: var(--turners-accent); }
        .queue-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .queue-card.warning .queue-value { color: var(--turners-warning); }
        .queue-card.danger .queue-value { color: var(--turners-danger); }

        /* Alert Items */
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid transparent;
        }
        .alert-item.critical { border-left-color: var(--turners-danger); }
        .alert-item.warning { border-left-color: var(--turners-warning); }
        .alert-item.info { border-left-color: var(--turners-accent); }
        .alert-item.resolved { opacity: 0.6; border-left-color: var(--turners-success); }

        .alert-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .alert-badge.critical { background: var(--turners-danger); color: #fff; }
        .alert-badge.warning { background: var(--turners-warning); color: #000; }
        .alert-badge.info { background: var(--turners-accent); color: #fff; }

        /* Quick Actions */
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
            height: 100%;
            min-height: 100px;
            border: none;
            cursor: pointer;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn i { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .action-btn span { font-weight: 600; font-size: 0.85rem; }
        .action-btn small { opacity: 0.75; font-size: 0.7rem; margin-top: 0.25rem; }

        .action-health { background: linear-gradient(135deg, var(--turners-success) 0%, #20c997 100%); color: #fff; }
        .action-metrics { background: linear-gradient(135deg, var(--turners-accent) 0%, #6bb3ff 100%); color: #fff; }
        .action-alerts { background: linear-gradient(135deg, var(--turners-orange) 0%, #fd7e14 100%); color: #fff; }
        .action-runbook { background: linear-gradient(135deg, #6f42c1 0%, #9b6bd4 100%); color: #fff; }

        /* Stat Boxes */
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--turners-accent); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }

        /* Buttons */
        .btn-custom {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
        }
        .btn-turners { background: var(--turners-primary); color: #fff; }
        .btn-turners:hover { background: var(--turners-secondary); color: #fff; }
        .btn-outline-turners { background: transparent; border: 2px solid var(--turners-primary); color: var(--turners-primary); }
        .btn-outline-turners:hover { background: var(--turners-primary); color: #fff; }

        /* Runbook Item */
        .runbook-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .runbook-item:hover { background: rgba(255,255,255,0.08); }
        .runbook-id { font-family: monospace; font-size: 0.75rem; color: var(--turners-accent); background: rgba(74,144,217,0.15); padding: 0.25rem 0.5rem; border-radius: 4px; }
        .runbook-title { flex: 1; margin: 0 1rem; font-size: 0.9rem; }
        .severity-badge { font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .severity-badge.high { background: var(--turners-danger); color: #fff; }
        .severity-badge.medium { background: var(--turners-warning); color: #000; }
        .severity-badge.low { background: var(--turners-accent); color: #fff; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }

        /* Section Title */
        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .main-container { padding: 1rem; }
            .health-title { font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-gear-fill me-2"></i>Operations Dashboard
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white small" id="lastUpdated">Updated: --</span>
                <button class="btn btn-sm btn-light" onclick="refreshAll()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Health Status Hero -->
        <div class="health-hero loading" id="healthHero">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="health-icon">
                        <i class="bi bi-heart-pulse" id="healthIcon"></i>
                    </div>
                    <div>
                        <div class="health-title" id="healthTitle">Checking...</div>
                        <div class="health-subtitle" id="healthSubtitle">System health status</div>
                    </div>
                </div>
                <div class="d-flex gap-3">
                    <div class="text-center">
                        <div class="stat-value" style="font-size: 1.5rem;" id="healthUptime">--</div>
                        <div class="health-subtitle">Uptime</div>
                    </div>
                    <div class="text-center">
                        <div class="stat-value" style="font-size: 1.5rem;" id="healthVersion">--</div>
                        <div class="health-subtitle">Version</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-title">Quick Actions</div>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <button class="action-btn action-health text-white w-100" onclick="runHealthCheck()">
                    <i class="bi bi-heart-pulse"></i>
                    <span>Health Check</span>
                    <small>Run full diagnostic</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="action-btn action-metrics text-white w-100" onclick="showMetrics()">
                    <i class="bi bi-graph-up"></i>
                    <span>View Metrics</span>
                    <small>Performance data</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="action-btn action-alerts text-white w-100" onclick="checkAlerts()">
                    <i class="bi bi-bell"></i>
                    <span>Check Alerts</span>
                    <small>Trigger alert check</small>
                </button>
            </div>
            <div class="col-md-3">
                <button class="action-btn action-runbook text-white w-100" onclick="showRunbooks()">
                    <i class="bi bi-book"></i>
                    <span>Runbooks</span>
                    <small>View procedures</small>
                </button>
            </div>
        </div>

        <div class="row g-4">
            <!-- Queue Status -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon blue"><i class="bi bi-list-check"></i></div>
                        <h5 class="card-title">Queue Status</h5>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="queue-card" id="queueReviewCard">
                                <div class="queue-value" id="queueReview">0</div>
                                <div class="queue-label">Review</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="queue-card">
                                <div class="queue-value" id="queueOut">0</div>
                                <div class="queue-label">Out</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="queue-card">
                                <div class="queue-value" id="queueEmail">0</div>
                                <div class="queue-label">Email</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="queue-card">
                                <div class="queue-value" id="queueRetry">0</div>
                                <div class="queue-label">Retry</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-turners btn-custom w-100 btn-sm" onclick="refreshQueues()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Queues
                    </button>
                </div>
            </div>

            <!-- Processing Metrics -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon green"><i class="bi bi-speedometer2"></i></div>
                        <h5 class="card-title">Processing Metrics</h5>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-value" id="metricToday">0</div>
                                <div class="stat-label">Today</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-value" id="metricWeek">0</div>
                                <div class="stat-label">This Week</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-value" id="metricSuccess">--%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-value" id="metricErrors">0</div>
                                <div class="stat-label">Errors</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Alerts -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon orange"><i class="bi bi-bell"></i></div>
                        <h5 class="card-title">Active Alerts</h5>
                        <span class="badge bg-danger ms-auto" id="alertCount">0</span>
                    </div>
                    <div id="alertsList" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted small text-center py-3">No active alerts</p>
                    </div>
                </div>
            </div>

            <!-- Health Details -->
            <div class="col-lg-6">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon green"><i class="bi bi-check-circle"></i></div>
                        <h5 class="card-title">Health Checks</h5>
                    </div>
                    <div id="healthChecks">
                        <div class="d-flex justify-content-between py-2 border-bottom" style="border-color: var(--border-color);">
                            <span>Database</span>
                            <span class="text-success"><i class="bi bi-check-circle"></i> OK</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom" style="border-color: var(--border-color);">
                            <span>Storage</span>
                            <span class="text-success"><i class="bi bi-check-circle"></i> OK</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom" style="border-color: var(--border-color);">
                            <span>Memory</span>
                            <span class="text-success"><i class="bi bi-check-circle"></i> OK</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span>Email Queue</span>
                            <span class="text-success"><i class="bi bi-check-circle"></i> OK</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Runbooks -->
            <div class="col-lg-6">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon purple"><i class="bi bi-book"></i></div>
                        <h5 class="card-title">Quick Runbooks</h5>
                    </div>
                    <div id="runbookList">
                        <div class="runbook-item" onclick="viewRunbook('WHATSAPP_DISCONNECTED')">
                            <span class="runbook-id">WHATSAPP</span>
                            <span class="runbook-title">Reconnect WhatsApp</span>
                            <span class="severity-badge high">HIGH</span>
                        </div>
                        <div class="runbook-item" onclick="viewRunbook('QUEUE_BACKLOG')">
                            <span class="runbook-id">QUEUE</span>
                            <span class="runbook-title">Clear queue backup</span>
                            <span class="severity-badge medium">MED</span>
                        </div>
                        <div class="runbook-item" onclick="viewRunbook('EMAIL_FAILURE')">
                            <span class="runbook-id">EMAIL</span>
                            <span class="runbook-title">SMTP troubleshooting</span>
                            <span class="severity-badge medium">MED</span>
                        </div>
                        <div class="runbook-item" onclick="viewRunbook('STORAGE_FULL')">
                            <span class="runbook-id">STORAGE</span>
                            <span class="runbook-title">Cleanup storage</span>
                            <span class="severity-badge high">HIGH</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Runbook Modal -->
    <div class="modal fade" id="runbookModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">
                        <span class="runbook-id me-2" id="runbookModalId">WHATSAPP</span>
                        <span id="runbookModalTitle">Runbook Title</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="runbookModalBody" style="max-height: 60vh; overflow-y: auto;">
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary btn-custom" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let runbookModal = null;

        document.addEventListener('DOMContentLoaded', () => {
            runbookModal = new bootstrap.Modal(document.getElementById('runbookModal'));
            refreshAll();
            // Auto-refresh every 30 seconds
            setInterval(refreshAll, 30000);
        });

        async function refreshAll() {
            await Promise.all([
                fetchHealth(),
                fetchMetrics(),
                fetchAlerts(),
                fetchRunbooks()
            ]);
        }

        async function fetchHealth() {
            try {
                const response = await fetch('/health?level=deep');
                const data = await response.json();

                const hero = document.getElementById('healthHero');
                const icon = document.getElementById('healthIcon');
                const title = document.getElementById('healthTitle');
                const subtitle = document.getElementById('healthSubtitle');

                hero.classList.remove('healthy', 'degraded', 'unhealthy', 'loading');
                hero.classList.add(data.status);

                icon.innerHTML = data.status === 'healthy' ? '<i class="bi bi-heart-pulse"></i>' :
                                 data.status === 'degraded' ? '<i class="bi bi-exclamation-triangle"></i>' :
                                 '<i class="bi bi-x-circle"></i>';

                title.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                document.getElementById('healthUptime').textContent = formatUptime(data.uptime);
                document.getElementById('healthVersion').textContent = data.version || '1.0.0';

                // Update health checks list
                if (data.checks) {
                    updateHealthChecks(data.checks);
                }
            } catch (error) {
                console.error('Health fetch error:', error);
            }
        }

        function updateHealthChecks(checks) {
            const container = document.getElementById('healthChecks');
            let html = '';

            Object.entries(checks).forEach(([name, check]) => {
                const statusIcon = check.status === 'healthy' ? '<i class="bi bi-check-circle text-success"></i>' :
                                   check.status === 'degraded' ? '<i class="bi bi-exclamation-triangle text-warning"></i>' :
                                   '<i class="bi bi-x-circle text-danger"></i>';
                html += `
                    <div class="d-flex justify-content-between py-2 border-bottom" style="border-color: var(--border-color);">
                        <span>${name.charAt(0).toUpperCase() + name.slice(1).replace(/([A-Z])/g, ' $1')}</span>
                        <span>${statusIcon} ${check.message || check.status}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();

                document.getElementById('metricToday').textContent = data.summary?.today || 0;
                document.getElementById('metricWeek').textContent = data.summary?.thisWeek || 0;
                document.getElementById('metricSuccess').textContent = (data.summary?.successRate || 100) + '%';
                document.getElementById('metricErrors').textContent = data.counters?.errors_total || 0;

                // Update queue cards
                const review = data.summary?.reviewQueue || 0;
                const reviewCard = document.getElementById('queueReviewCard');
                reviewCard.classList.remove('warning', 'danger');
                if (review > 100) reviewCard.classList.add('danger');
                else if (review > 50) reviewCard.classList.add('warning');
                document.getElementById('queueReview').textContent = review;

                document.getElementById('queueOut').textContent = data.summary?.statusBreakdown?.OUT || 0;
                document.getElementById('queueEmail').textContent = data.summary?.pendingEmails || 0;

                // Get retry queue
                const queueRes = await fetch('/api/metrics/queues');
                const queueData = await queueRes.json();
                document.getElementById('queueRetry').textContent = queueData.retryQueue || 0;

                document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Metrics fetch error:', error);
            }
        }

        async function fetchAlerts() {
            try {
                const response = await fetch('/api/alerts/active');
                const data = await response.json();

                const count = data.alerts?.length || 0;
                document.getElementById('alertCount').textContent = count;

                const container = document.getElementById('alertsList');
                if (count === 0) {
                    container.innerHTML = '<p class="text-muted small text-center py-3"><i class="bi bi-check-circle text-success me-2"></i>No active alerts</p>';
                    return;
                }

                container.innerHTML = data.alerts.map(alert => `
                    <div class="alert-item ${alert.level.toLowerCase()}">
                        <span class="alert-badge ${alert.level.toLowerCase()}">${alert.level}</span>
                        <div class="flex-grow-1">
                            <div class="small fw-bold">${alert.title}</div>
                            <div class="small text-muted">${alert.message}</div>
                            <div class="small text-muted mt-1">${formatTime(alert.timestamp)}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="acknowledgeAlert('${alert.id}')">
                            <i class="bi bi-check"></i>
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Alerts fetch error:', error);
            }
        }

        async function fetchRunbooks() {
            // Runbooks loaded on demand
        }

        async function runHealthCheck() {
            await fetchHealth();
            showToast('Health check completed', 'success');
        }

        async function showMetrics() {
            await fetchMetrics();
            showToast('Metrics refreshed', 'success');
        }

        async function checkAlerts() {
            try {
                await fetch('/api/alerts/check', { method: 'POST' });
                await fetchAlerts();
                showToast('Alert check completed', 'success');
            } catch (error) {
                showToast('Alert check failed: ' + error.message, 'error');
            }
        }

        async function showRunbooks() {
            await fetchRunbooks();
            runbookModal.show();
        }

        async function viewRunbook(id) {
            try {
                const response = await fetch(`/api/runbooks/${id}`);
                const data = await response.json();

                if (data.error) {
                    showToast('Runbook not found', 'error');
                    return;
                }

                document.getElementById('runbookModalId').textContent = data.id;
                document.getElementById('runbookModalTitle').textContent = data.title;

                let html = `
                    <div class="mb-3">
                        <span class="severity-badge ${data.severity?.toLowerCase() || 'medium'} me-2">${data.severity || 'MEDIUM'}</span>
                        <span class="text-muted small">${data.symptoms?.join(', ') || ''}</span>
                    </div>
                    <h6 class="mb-2">Causes</h6>
                    <ul class="mb-3 small">
                        ${(data.causes || []).map(c => `<li>${c}</li>`).join('') || '<li>Unknown</li>'}
                    </ul>
                    <h6 class="mb-2">Resolution Steps</h6>
                    <ol class="small">
                        ${(data.steps || []).map(s => `<li><strong>${s.action}:</strong> ${s.description}</li>`).join('') || '<li>No steps defined</li>'}
                    </ol>
                    ${data.prevention ? `<div class="mt-3 p-2 rounded" style="background: rgba(40,167,69,0.1);">
                        <strong class="text-success">Prevention:</strong> ${data.prevention}
                    </div>` : ''}
                `;

                document.getElementById('runbookModalBody').innerHTML = html;
                runbookModal.show();
            } catch (error) {
                showToast('Failed to load runbook: ' + error.message, 'error');
            }
        }

        async function acknowledgeAlert(id) {
            try {
                await fetch(`/api/alerts/acknowledge/${id}`, { method: 'POST' });
                await fetchAlerts();
                showToast('Alert acknowledged', 'success');
            } catch (error) {
                showToast('Failed to acknowledge alert', 'error');
            }
        }

        async function refreshQueues() {
            await fetchMetrics();
            showToast('Queues refreshed', 'success');
        }

        function formatUptime(seconds) {
            if (!seconds || seconds < 0) return '--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
