<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Admin - Turners Distribution</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --wa-green: #00a884;
            --wa-green-dark: #008069;
            --wa-green-light: #25d366;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border-color: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation */
        .navbar-custom {
            background: linear-gradient(135deg, var(--wa-green) 0%, var(--wa-green-dark) 100%);
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 20px rgba(0, 168, 132, 0.3);
        }
        .navbar-brand {
            color: #fff !important;
            font-weight: 600;
            font-size: 1.25rem;
        }
        .nav-link {
            color: rgba(255,255,255,0.85) !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin: 0 0.25rem;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.15);
            color: #fff !important;
        }
        .nav-icon {
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }

        /* Main Container */
        .main-container {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Status Hero */
        .status-hero {
            background: linear-gradient(135deg, var(--wa-green) 0%, var(--wa-green-dark) 100%);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            color: #fff;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 168, 132, 0.25);
        }
        .status-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .status-hero.disconnected {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.25);
        }
        .status-hero.connecting {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #d97706 100%);
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.25);
        }
        .status-icon {
            width: 64px;
            height: 64px;
            background: rgba(255,255,255,0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        .status-text {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .status-subtext {
            font-size: 1rem;
            opacity: 0.85;
        }

        /* Cards */
        .custom-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            height: 100%;
        }
        .custom-card:hover {
            background: var(--bg-card-hover);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.3);
        }
        .card-header-custom {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .card-icon.green { background: rgba(0,168,132,0.15); color: var(--wa-green); }
        .card-icon.blue { background: rgba(59,130,246,0.15); color: var(--accent-blue); }
        .card-icon.purple { background: rgba(139,92,246,0.15); color: var(--accent-purple); }
        .card-icon.orange { background: rgba(245,158,11,0.15); color: var(--accent-orange); }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Quick Actions */
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            border-radius: 12px;
            text-decoration: none;
            transition: all 0.3s ease;
            height: 100%;
            min-height: 120px;
        }
        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .action-btn i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        .action-btn span {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .action-btn small {
            opacity: 0.75;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .action-broadcast { background: linear-gradient(135deg, var(--wa-green) 0%, var(--wa-green-dark) 100%); color: #fff; }
        .action-groups { background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%); color: #fff; }
        .action-pod { background: linear-gradient(135deg, var(--accent-purple) 0%, #7c3aed 100%); color: #fff; }
        .action-status { background: var(--bg-card-hover); color: var(--text-primary); border: 2px solid var(--border-color); }

        /* Stats */
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--wa-green);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn-custom {
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
        }
        .btn-wa { background: var(--wa-green); color: #fff; }
        .btn-wa:hover { background: var(--wa-green-dark); color: #fff; }
        .btn-outline-wa {
            background: transparent;
            border: 2px solid var(--wa-green);
            color: var(--wa-green);
        }
        .btn-outline-wa:hover {
            background: var(--wa-green);
            color: #fff;
        }
        .btn-danger-custom {
            background: var(--accent-red);
            color: #fff;
        }
        .btn-danger-custom:hover {
            background: #dc2626;
            color: #fff;
        }

        /* Form Elements */
        .form-control-custom {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .form-control-custom:focus {
            background: rgba(255,255,255,0.08);
            border-color: var(--wa-green);
            box-shadow: 0 0 0 3px rgba(0,168,132,0.15);
            color: var(--text-primary);
        }
        .form-control-custom::placeholder {
            color: var(--text-secondary);
        }
        textarea.form-control-custom {
            min-height: 120px;
            resize: vertical;
        }

        /* Group Items */
        .group-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        .group-item:hover {
            border-color: var(--wa-green);
            background: rgba(0,168,132,0.05);
        }
        .group-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .group-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Checkbox styling */
        .form-check-input {
            background-color: rgba(255,255,255,0.1);
            border-color: var(--border-color);
            cursor: pointer;
        }
        .form-check-input:checked {
            background-color: var(--wa-green);
            border-color: var(--wa-green);
        }

        /* Log Container */
        .log-container {
            background: #08080c;
            border-radius: 12px;
            padding: 1rem;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 250px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.4rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .log-time {
            color: var(--text-secondary);
            margin-right: 0.75rem;
        }
        .log-msg {
            color: var(--text-primary);
        }
        .log-success { color: var(--wa-green); }
        .log-error { color: var(--accent-red); }
        .log-warn { color: var(--accent-orange); }

        /* Section Title */
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a4a; }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0,168,132,0.4); }
            50% { box-shadow: 0 0 0 10px rgba(0,168,132,0); }
        }
        .connected-pulse {
            animation: pulse-glow 2s infinite;
        }

        /* QR Code */
        .qr-frame {
            background: #fff;
            padding: 1rem;
            border-radius: 12px;
            display: inline-block;
        }

        /* Quick Stats Row */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .main-container { padding: 1rem; }
            .status-hero { padding: 1.5rem; }
            .status-text { font-size: 1.75rem; }
            .quick-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-whatsapp me-2"></i>WhatsApp Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="bi bi-house-door nav-icon"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://hrms.turners-distribution.cloud/whatsapp-broadcast/">
                            <i class="bi bi-megaphone nav-icon"></i>Broadcast
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://admin.turners-distribution.cloud/pod/">
                            <i class="bi bi-clipboard-check nav-icon"></i>POD Portal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://hrms.turners-distribution.cloud/whatsapp-status/">
                            <i class="bi bi-info-circle nav-icon"></i>Status
                        </a>
                    </li>
                </ul>
                <span class="navbar-text text-white" id="navStatus">
                    <i class="bi bi-circle-fill me-2 text-warning"></i>Connecting...
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Connection Status Hero -->
        <div class="status-hero" id="statusHero">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center gap-4">
                        <div class="status-icon">
                            <i class="bi bi-whatsapp"></i>
                        </div>
                        <div>
                            <div class="status-text" id="statusText">
                                <i class="bi bi-arrow-repeat me-2 connected-pulse"></i>Connecting...
                            </div>
                            <div class="status-subtext" id="statusSubtext">Turners Distribution - Fleet Communication</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mt-3 mt-lg-0">
                    <div class="d-flex gap-2 justify-content-lg-end flex-wrap">
                        <button class="btn btn-light btn-custom" onclick="refreshStatus()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                        <button class="btn btn-outline-light btn-custom" onclick="showQR()">
                            <i class="bi bi-qr-code me-1"></i>QR Code
                        </button>
                        <button class="btn btn-light btn-custom" onclick="reconnect()">
                            <i class="bi bi-wifi me-1"></i>Connect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="custom-card">
                <div class="stat-box">
                    <div class="stat-value" id="uptimeValue">--</div>
                    <div class="stat-label">Uptime</div>
                </div>
            </div>
            <div class="custom-card">
                <div class="stat-box">
                    <div class="stat-value" id="groupsValue">--</div>
                    <div class="stat-label">Groups</div>
                </div>
            </div>
            <div class="custom-card">
                <div class="stat-box">
                    <div class="stat-value" id="queueValue">0</div>
                    <div class="stat-label">POD Queue</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-title">Quick Actions</div>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <a href="#" onclick="showBroadcastModal(); return false;" class="action-btn action-broadcast text-white text-decoration-none">
                    <i class="bi bi-megaphone"></i>
                    <span>Broadcast</span>
                    <small>Send to all drivers</small>
                </a>
            </div>
            <div class="col-md-3">
                <a href="https://hrms.turners-distribution.cloud/whatsapp-broadcast/groups/" class="action-btn action-groups text-white text-decoration-none">
                    <i class="bi bi-people-fill"></i>
                    <span>Group Message</span>
                    <small>Select specific groups</small>
                </a>
            </div>
            <div class="col-md-3">
                <a href="https://admin.turners-distribution.cloud/pod/" target="_blank" class="action-btn action-pod text-white text-decoration-none">
                    <i class="bi bi-clipboard-check-fill"></i>
                    <span>POD Portal</span>
                    <small>Review & process</small>
                </a>
            </div>
            <div class="col-md-3">
                <a href="https://hrms.turners-distribution.cloud/whatsapp-status/" target="_blank" class="action-btn action-status text-decoration-none">
                    <i class="bi bi-info-circle-fill" style="color: var(--wa-green);"></i>
                    <span>Full Status</span>
                    <small>Detailed view</small>
                </a>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="row g-4">
            <!-- QR & Auth -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon green"><i class="bi bi-qr-code"></i></div>
                        <h5 class="card-title">Authentication</h5>
                    </div>
                    <div class="text-center mb-3">
                        <div class="qr-frame">
                            <div id="qrContainer" style="width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; color: #333;">
                                <i class="bi bi-clock-history" style="font-size: 3rem; color: #ccc;"></i>
                            </div>
                        </div>
                        <p class="text-muted small mt-2 mb-0">Scan with WhatsApp to connect</p>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-wa btn-custom" onclick="refreshQR()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh QR
                        </button>
                        <button class="btn btn-wa btn-custom" onclick="reconnect()">
                            <i class="bi bi-wifi me-1"></i>Reconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- Broadcast -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon blue"><i class="bi bi-send"></i></div>
                        <h5 class="card-title">Quick Broadcast</h5>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Select Recipients</label>
                        <div id="broadcastGroups" style="max-height: 100px; overflow-y: auto;">
                            <p class="text-muted small">Loading groups...</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Message</label>
                        <textarea class="form-control-custom" id="broadcastMessage" placeholder="Type your message..."></textarea>
                    </div>
                    <button class="btn btn-wa btn-custom w-100" onclick="sendBroadcast()">
                        <i class="bi bi-send-fill me-1"></i>Send Broadcast
                    </button>
                </div>
            </div>

            <!-- Groups -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon purple"><i class="bi bi-people-fill"></i></div>
                        <h5 class="card-title">Available Groups</h5>
                    </div>
                    <div id="groupsList" style="max-height: 280px; overflow-y: auto;">
                        <p class="text-muted small">Loading groups...</p>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="col-lg-8">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon orange"><i class="bi bi-clock-history"></i></div>
                        <h5 class="card-title">Activity Log</h5>
                        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="clearLog()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="log-container" id="activityLog">
                        <div class="log-entry">
                            <span class="log-time">[--:--:--]</span>
                            <span class="log-msg">System initialized...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Control -->
            <div class="col-lg-4">
                <div class="custom-card">
                    <div class="card-header-custom">
                        <div class="card-icon" style="background: rgba(239,68,68,0.15); color: var(--accent-red);">
                            <i class="bi bi-gear-fill"></i>
                        </div>
                        <h5 class="card-title">Service Control</h5>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-wa btn-custom" onclick="restartService()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Restart Service
                        </button>
                        <button class="btn btn-danger-custom btn-custom" onclick="stopService()">
                            <i class="bi bi-stop-circle me-1"></i>Stop Service
                        </button>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Service Port:</span>
                            <span class="text-light">3000</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>API Base:</span>
                            <span class="text-light">/api/</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Version:</span>
                            <span class="text-light">1.0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Broadcast Modal -->
    <div class="modal fade" id="broadcastModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title"><i class="bi bi-megaphone me-2"></i>Select Groups</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="modalGroupsList"></div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary btn-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-wa btn-custom" onclick="confirmModalBroadcast()">
                        <i class="bi bi-send-fill me-1"></i>Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title"><i class="bi bi-qr-code me-2"></i>QR Code</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="qr-frame d-inline-block">
                        <div id="qrModalContent" style="width: 250px; height: 250px; display: flex; align-items: center; justify-content: center; color: #333;">
                            <i class="bi bi-clock-history" style="font-size: 4rem; color: #ccc;"></i>
                        </div>
                    </div>
                    <p class="text-muted small mt-3 mb-0">Scan this code with WhatsApp to connect</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let status = { connected: false, uptime: 0, phone: '' };
        let groups = [];
        let broadcastModal = null;
        let qrModal = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            broadcastModal = new bootstrap.Modal(document.getElementById('broadcastModal'));
            qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
            fetchStatus();
            fetchGroups();
            setInterval(fetchStatus, 5000);
            setInterval(fetchGroups, 30000);
            log('WhatsApp Admin interface loaded');
        });

        async function fetchStatus() {
            try {
                const response = await fetch('/status');
                if (!response.ok) throw new Error('Network error');
                status = await response.json();
                updateStatusUI();
            } catch (error) {
                updateStatusUI(false);
            }
        }

        async function fetchGroups() {
            try {
                const response = await fetch('/api/broadcast/groups');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                groups = data.groups || [];
                updateGroupsUI();
            } catch (error) {
                logError('Failed to load groups');
            }
        }

        function updateStatusUI(fetched = true) {
            const hero = document.getElementById('statusHero');
            const text = document.getElementById('statusText');
            const navStatus = document.getElementById('navStatus');
            const uptime = document.getElementById('uptimeValue');
            const groupsVal = document.getElementById('groupsValue');

            hero.classList.remove('connected', 'disconnected', 'connecting');

            if (!fetched || !status.connected) {
                hero.classList.add('disconnected');
                text.innerHTML = '<i class="bi bi-x-circle me-2"></i>Disconnected';
                navStatus.innerHTML = '<i class="bi bi-circle-fill me-2 text-danger"></i>Offline';
            } else {
                hero.classList.add('connected');
                text.innerHTML = '<i class="bi bi-check-circle-fill connected-pulse me-2"></i>Connected';
                navStatus.innerHTML = '<i class="bi bi-circle-fill me-2 text-success"></i>Online';
                if (status.phone) {
                    text.innerHTML += `<small class="d-block ms-4 opacity-75" style="font-size: 1rem;">${status.phone}</small>`;
                }
            }

            uptime.textContent = formatUptime(status.uptime);
            groupsVal.textContent = groups.length;
        }

        function updateGroupsUI() {
            const groupsList = document.getElementById('groupsList');
            const broadcastGroups = document.getElementById('broadcastGroups');
            const modalGroups = document.getElementById('modalGroupsList');

            if (groups.length === 0) {
                groupsList.innerHTML = '<p class="text-muted small">No groups found</p>';
                broadcastGroups.innerHTML = '<p class="text-muted small">No groups available</p>';
                modalGroups.innerHTML = '<p class="text-muted small p-3">No groups available</p>';
                return;
            }

            const groupItems = groups.map(g => `
                <div class="group-item">
                    <span class="group-name">${escapeHtml(g.name)}</span>
                    <span class="group-count">${g.participantCount || 0} members</span>
                </div>
            `).join('');

            const checkboxItems = groups.map(g => `
                <div class="group-item">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" value="${escapeHtml(g.id)}" id="group_${escapeHtml(g.id)}">
                        <label class="form-check-label" for="group_${escapeHtml(g.id)}">
                            <span class="group-name">${escapeHtml(g.name)}</span>
                        </label>
                    </div>
                    <span class="group-count">${g.participantCount || 0}</span>
                </div>
            `).join('');

            groupsList.innerHTML = groupItems;
            broadcastGroups.innerHTML = checkboxItems;
            modalGroups.innerHTML = checkboxItems;
        }

        function showQR() {
            qrModal.show();
            if (status.connected) {
                document.getElementById('qrModalContent').innerHTML = '<p class="text-muted">Already connected</p>';
            } else {
                document.getElementById('qrModalContent').innerHTML = '<p class="text-muted">Refresh to get QR</p>';
            }
        }

        function refreshQR() {
            log('Refreshing QR code...');
            reconnect();
        }

        function reconnect() {
            fetch('/api/reconnect', { method: 'POST' })
                .then(() => {
                    log('Reconnection initiated...', 'success');
                    setTimeout(fetchStatus, 2000);
                })
                .catch(() => logError('Failed to reconnect'));
        }

        function refreshStatus() {
            fetchStatus();
            log('Status refreshed');
        }

        function showBroadcastModal() {
            if (groups.length === 0) {
                alert('No groups available for broadcast');
                return;
            }
            broadcastModal.show();
        }

        function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            const checkboxes = document.querySelectorAll('#broadcastGroups input[type="checkbox"]:checked');
            const selectedGroups = Array.from(checkboxes).map(cb => ({
                group: cb.id.replace('group_', '')
            }));

            if (selectedGroups.length === 0) {
                alert('Please select at least one group');
                return;
            }

            executeBroadcast(selectedGroups, message);
        }

        function confirmModalBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message first');
                return;
            }

            const checkboxes = document.querySelectorAll('#modalGroupsList input[type="checkbox"]:checked');
            const selectedGroups = Array.from(checkboxes).map(cb => ({
                group: cb.id.replace('group_', '')
            }));

            if (selectedGroups.length === 0) {
                alert('Please select at least one group');
                return;
            }

            broadcastModal.hide();
            executeBroadcast(selectedGroups, message);
        }

        function executeBroadcast(recipients, message) {
            log(`Sending broadcast to ${recipients.length} group(s)...`, 'warn');

            fetch('/api/broadcast/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recipients, message })
            })
            .then(r => r.json())
            .then(data => {
                if (data.delivered && data.delivered.length > 0) {
                    log(`Broadcast sent to ${data.delivered.length} group(s)`, 'success');
                    document.getElementById('broadcastMessage').value = '';
                } else {
                    logError('Broadcast failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(e => logError('Broadcast failed: ' + e.message));
        }

        function restartService() {
            if (confirm('Restart the WhatsApp service?')) {
                log('Restarting service...', 'warn');
                fetch('/api/restart', { method: 'POST' })
                    .then(() => {
                        setTimeout(fetchStatus, 3000);
                        log('Service restart initiated', 'success');
                    })
                    .catch(() => logError('Failed to restart service'));
            }
        }

        function stopService() {
            if (confirm('Stop the WhatsApp service? This will disconnect all users.')) {
                log('Service stop requested', 'error');
            }
        }

        function log(message, type = 'info') {
            const container = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-msg log-${type}">${escapeHtml(message)}</span>
            `;
            container.insertBefore(entry, container.firstChild);
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function logError(message) {
            log(message, 'error');
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
        }

        function formatUptime(seconds) {
            if (!seconds || seconds < 0) return '--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
